name: TaskFlow CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Test Application
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-flask flake8
    
    - name: Lint with flake8
      run: |
        # Stop build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Run tests with pytest
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=term
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verify application structure
      run: |
        echo "Checking application files..."
        test -f app.py && echo "âœ“ app.py found"
        test -d templates && echo "âœ“ templates directory found"
        test -d static && echo "âœ“ static directory found"
        test -f requirements.txt && echo "âœ“ requirements.txt found"
    
    - name: Test Flask application startup
      run: |
        timeout 10 python app.py & 
        sleep 5
        curl -f http://localhost:5000 || exit 1
        echo "âœ“ Application started successfully"

  deploy-ready:
    name: Deployment Ready Check
    runs-on: ubuntu-latest
    needs: [test, build]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deployment ready notification
      run: |
        echo "ðŸš€ All checks passed! Application is ready for deployment."
        echo "âœ“ Tests passed"
        echo "âœ“ Build successful"
        echo "âœ“ Code quality verified"

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [test, build, deploy-ready]
    if: always()
    
    steps:
    - name: Check workflow status
      id: check
      run: |
        if [[ "${{ needs.test.result }}" == "success" && "${{ needs.build.result }}" == "success" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=âœ… TaskFlow CI/CD Pipeline Succeeded!" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=âŒ TaskFlow CI/CD Pipeline Failed!" >> $GITHUB_OUTPUT
        fi
    
    - name: Send email notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: ${{ steps.check.outputs.message }}
        to: ${{ secrets.EMAIL_TO }}
        from: TaskFlow CI/CD Bot
        body: |
          Workflow: ${{ github.workflow }}
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          Status: ${{ steps.check.outputs.status }}
          
          View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      continue-on-error: true
